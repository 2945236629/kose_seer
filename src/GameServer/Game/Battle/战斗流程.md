# 战斗流程详解

## 目录

- [一、架构总览](#一架构总览)
- [二、战斗生命周期](#二战斗生命周期)
- [三、回合执行流程](#三回合执行流程)
- [四、先手判定](#四先手判定)
- [五、9 阶段出手流程](#五9-阶段出手流程)
- [六、核心公式](#六核心公式)
- [七、PvE 与 PvP 差异](#七pve-与-pvp-差异)
- [八、特殊操作流程](#八特殊操作流程)
- [九、效果钩子一览](#九效果钩子一览)

---

## 一、架构总览

```
客户端请求 (Handler)
    │
    ▼
BattleManager          ← 入口层：接收客户端指令，分发PvE/PvP
    │
    ▼
BattleTurnService      ← 服务层：加载技能配置，AI选技能，调用执行器
    │
    ▼
BattleTurnExecutor     ← 执行层：完整回合逻辑（先手判定→双方攻击→回合结束）
    │
    ├── BattleCore                ← 核心计算：命中/暴击/伤害/速度/状态
    ├── BattleAlgorithm           ← 数值公式：属性计算/伤害公式/等级修正
    ├── BattleEffectIntegration   ← 效果集成：被动特性/技能效果的 26 个钩子
    ├── EffectTrigger             ← 效果触发：技能附带效果的触发和应用
    └── BattleAI                  ← AI系统：敌方技能选择（仅PvE）
```

### 关键文件

| 文件 | 职责 |
|------|------|
| `BattleManager.ts` | 接收客户端指令（使用技能/换精灵/捕捉/逃跑），管理战斗生命周期 |
| `BattleTurnService.ts` | 加载技能配置，PvE时AI选技能，调用执行器 |
| `BattleTurnExecutor.ts` | 执行完整回合：先手判定 → 9阶段出手 → 回合结束 |
| `BattleCore.ts` | 命中判定、暴击判定、伤害计算、速度比较、状态处理 |
| `BattleAlgorithm.ts` | 属性公式、伤害公式、能力等级倍率表、属性克制表 |
| `BattleEffectIntegration.ts` | 26个效果钩子，连接被动特性和技能效果到战斗各阶段 |
| `BattlePetProxy.ts` | Proxy自动同步 `status`↔`statusArray`、`battleLevels`↔`battleLv` |
| `BattleAI.ts` | AI技能评分和选择系统 |

---

## 二、战斗生命周期

### 2.1 PvE 流程

```
1. 客户端发送 FIGHT_NPC_MONSTER (2408) 或 CHALLENGE_BOSS (2411)
   │
   ▼
2. BattleManager.HandleFightNpcMonster / HandleChallengeBoss
   ├── 验证怪物/BOSS存在
   ├── 调用 InitService.CreatePVEBattle() 创建战斗实例
   ├── InitializeBattle() 初始化（创建 BattlePetProxy）
   ├── 发送确认包
   └── 发送 NOTE_READY_TO_FIGHT (2503) — 告诉客户端进入战斗场景
   │
   ▼
3. 客户端发送 READY_TO_FIGHT (2401)
   │
   ▼
4. BattleManager.HandleReadyToFight
   ├── 初始化HP记录
   ├── 触发 OnBattleStart 效果（被动特性初始化）
   └── 发送 NOTE_START_FIGHT (2501) — 包含双方精灵信息
   │
   ▼
5. 战斗循环（客户端每回合发送以下之一）：
   ├── USE_SKILL (2405)      → HandleUseSkill       → 执行回合
   ├── CHANGE_PET (2407)     → HandleChangePet       → 换精灵 + 敌方反击
   ├── CATCH_MONSTER (2409)  → HandleCatchMonster     → 捕捉 + 失败时敌方反击
   ├── USE_PET_ITEM (2406)   → HandleUsePetItem       → 使用道具
   └── ESCAPE_FIGHT (2410)   → HandleEscapeFight      → 逃跑
   │
   ▼
6. 战斗结束
   ├── 同步精灵HP到数据库
   ├── 触发 OnBattleEnd 效果
   ├── PVE胜利：计算经验/金币/掉落奖励
   ├── 发送 NOTE_FIGHT_OVER (2502)
   ├── 刷新地图野怪
   └── 清理战斗实例
```

### 2.2 PvP 流程

```
1. 玩家A发送对战邀请 → PvpBattleManager 创建房间
   │
   ▼
2. 玩家B接受邀请 → 双方收到 NOTE_READY_TO_FIGHT (2503)
   │
   ▼
3. 双方发送 READY_TO_FIGHT (2401)
   ├── 第一个到达：标记为已准备，等待对方
   └── 第二个到达：
       ├── CreatePvpBattle() — 双方首发精灵构建战斗实例
       ├── 双方 InitializeBattle() 共享同一个 battle 实例
       ├── 触发 OnBattleStart
       └── 双方各收到 NOTE_START_FIGHT (2501)
   │
   ▼
4. 每回合双方独立提交动作：
   ├── USE_SKILL (2405) → HandlePvpUseSkill → PvpBattleManager.SetPlayerAction
   └── CHANGE_PET (2407) → HandleChangePet → PvpBattleManager.SetPlayerAction
   │
   第一个提交：等待
   第二个提交：触发 ResolvePvpTurn()
   │
   ▼
5. ResolvePvpTurn()
   ├── 获取双方 action
   ├── 换精灵动作先执行（不消耗回合攻击，skillId=0）
   ├── 调用 TurnService.ExecuteTurn(battle, p1Skill, p2Skill) — 传入双方技能ID
   ├── 构建攻击结果
   ├── 双方各收到 NOTE_USE_SKILL
   └── 检查战斗结束（一方所有精灵阵亡 → 结束）
   │
   ▼
6. 战斗结束：双方各收到 NOTE_FIGHT_OVER
```

---

## 三、回合执行流程

入口：`BattleTurnExecutor.ExecuteTurn()`

```
┌─────────────────────────────────────────────────────────┐
│                    回合开始                               │
│                                                          │
│  1. battle.turn++                                        │
│  2. 加载技能配置 (LoadSkillConfig)                        │
│  3. PvE: AI选择敌方技能 (BattleAI.SelectSkill)            │
│     PvP: 使用玩家提交的技能ID                              │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│              OnTurnStart — 回合开始效果                    │
│                                                          │
│  ・被动特性的回合开始效果                                   │
│  ・状态持续时间递减                                        │
│  ・效果计数器递减                                          │
│  ・死亡检查（效果致死 → 提前返回）                           │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│          获取技能 & PvE专用回合开始处理                     │
│                                                          │
│  ・获取双方技能配置                                        │
│  ・PvP: skillId=0 → GetNoActionSkill()（换精灵不攻击）     │
│  ・PvE专用: ProcessTurnStartEffects()                     │
│    - 克制(encore)回合递减                                  │
│    - TURN_START 时机的技能效果                             │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│               CanAct — 行动判定                           │
│                                                          │
│  按优先级检查（命中即返回不可行动）：                         │
│  ・PvP换精灵 (skillId=0) → 不攻击                         │
│  ・疲惫 (fatigueTurns > 0) → 无法行动                     │
│  ・睡眠 (SLEEP) → 无法行动                                │
│  ・石化 (PETRIFY) → 无法行动                              │
│  ・冰封 (ICE_SEAL) → 无法行动                             │
│  ・麻痹 (PARALYSIS) → 25%几率无法行动                     │
│  ・害怕 (FEAR) → 50%几率无法行动                          │
│  ・混乱 (CONFUSION) → 33%几率无法行动                     │
│  ・畏缩 (flinched) → 无法行动（一次性）                    │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│            先手判定 — CompareSpeed                        │
│            （详见第四节）                                   │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│                   执行攻击                                │
│                                                          │
│  先手方 → ExecuteAttack (9阶段出手流程)                    │
│    ├── 对方死亡? → 战斗结束                               │
│    └── 对方存活? → 后手方 ExecuteAttack                   │
│                    └── 对方死亡? → 战斗结束                │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│        阶段9: OnAfterAttackEnd — 双方攻击完成后            │
│                                                          │
│  ・死亡检查                                               │
└────────────────────────┬────────────────────────────────┘
                         ▼
┌─────────────────────────────────────────────────────────┐
│              OnTurnEnd — 回合结束效果                      │
│                                                          │
│  ・持续伤害（中毒/烧伤等）                                 │
│  ・回合结束时机的被动特性                                   │
│  ・死亡检查                                               │
└────────────────────────┬────────────────────────────────┘
                         ▼
                    返回回合结果
```

---

## 四、先手判定

`BattleCore.CompareSpeed()` — 判定谁先出手

### 判定优先级（从高到低）

```
┌────────────────────────────────────────────────────────────────┐
│ 1. alwaysFirst（被动特性强制先手）                                │
│    ├── 一方有 alwaysFirst，另一方没有 → 有的先手                  │
│    └── 双方都有 或 都没有 → 继续下一步                            │
│                                                                 │
│ 2. 技能优先度（priority）                                        │
│    ├── 公式: clamp(skill.priority + priorityMod, -128, +127)    │
│    ├── priorityMod 来自被动特性（OnBeforeSpeedCheck钩子）         │
│    ├── 高者先手                                                  │
│    └── 相同 → 继续下一步                                         │
│                                                                 │
│ 3. 速度比较                                                      │
│    ├── 基础速度 × 能力等级修正（battleLv[4]）                      │
│    │   等级修正表: +1→×1.5  +2→×2  ... +6→×4                    │
│    │              -1→×0.67 -2→×0.5 ... -6→×0.25                 │
│    ├── 麻痹状态 → 速度减半                                       │
│    ├── 高者先手                                                  │
│    └── 相同 → 继续下一步                                         │
│                                                                 │
│ 4. 平局 → 挑战方(player/player1)先手                             │
└────────────────────────────────────────────────────────────────┘
```

### OnBeforeSpeedCheck 返回值

```typescript
{
  playerAlwaysFirst: boolean;    // 玩家被动特性强制先手
  enemyAlwaysFirst: boolean;     // 敌方被动特性强制先手
  playerPriorityMod: number;     // 玩家优先度修正值
  enemyPriorityMod: number;      // 敌方优先度修正值
}
```

---

## 五、9 阶段出手流程

`BattleTurnExecutor.ExecuteAttack()` — 单次攻击的完整流程

每个攻击方执行一次完整的9阶段流程。先手方先执行，如果对方存活则后手方再执行。

```
  攻击方 → 防御方

  ┌─────────────────────────────────────────────────────┐
  │ 无法行动检查 (CanAct返回false)                        │
  │ → 返回空攻击结果 (skillId=0, damage=0)               │
  └─────────────────────┬───────────────────────────────┘
                        ▼ (可以行动)
  ┌─────────────────────────────────────────────────────┐
  │ 阶段1: ATTACK_START — 出手流程开始                     │
  │                                                      │
  │ ・处理防御方的异常状态伤害：                             │
  │   - 中毒: 每回合损失 1/8 maxHP                        │
  │   - 烧伤: 每回合损失 1/16 maxHP                       │
  │   - 冻伤: 每回合损失 1/16 maxHP                       │
  │   - 流血: 每回合损失 1/8 maxHP                        │
  │   - 束缚: 每回合损失 1/16 maxHP                       │
  │ ・触发 ATTACK_START 效果                              │
  │ ・防御方被状态致死? → 提前返回                          │
  └─────────────────────┬───────────────────────────────┘
                        ▼
  ┌─────────────────────────────────────────────────────┐
  │ 阶段2: 命中判定                                       │
  │                                                      │
  │ ① OnAttack — 攻击时效果                              │
  │ ② OnBeforeSkill — 技能使用前效果                      │
  │ ③ OnBeforeHitCheck — 命中判定前效果                   │
  │ ④ CheckHit 命中判定：                                 │
  │    a. mustHit = true → 命中                          │
  │    b. 效果检查 (never_miss) → 命中                    │
  │    c. accuracy >= 100 → 命中                         │
  │    d. 计算最终命中率：                                 │
  │       finalAcc = baseAcc × accMul / evaMul           │
  │       accMul = 攻击方 battleLv[5] 的命中倍率           │
  │       evaMul = 防御方 battleLv[5] 的闪避倍率           │
  │       （3/3分数系统，见第六节）                         │
  │    e. random() × 100 <= finalAcc → 命中              │
  │ ⑤ OnAfterHitCheck — 命中判定后效果                    │
  │                                                      │
  │ 未命中 → OnEvade → AFTER_SKILL效果 → 跳到阶段8        │
  └─────────────────────┬───────────────────────────────┘
                        ▼ (命中)
  ┌─────────────────────────────────────────────────────┐
  │ 阶段3: ON_HIT — 命中时                                │
  │                                                      │
  │ ・OnHit — 命中时效果                                  │
  │ ・OnAttacked — 受到攻击时效果                          │
  └─────────────────────┬───────────────────────────────┘
                        ▼
  ┌─────────────────────────────────────────────────────┐
  │ 阶段4: SKILL_EFFECT — 即时技能效果结算                  │
  │                                                      │
  │ ・OnSkillEffect — 即时效果（能力变化、状态施加等）       │
  │                                                      │
  │ 如果是变化技能 (category=4):                           │
  │   → 跳过暴击判定和伤害计算，damage=0                   │
  │                                                      │
  │ 物理/特殊技能继续：                                     │
  │ ・OnBeforeCritCheck — 暴击判定前效果                   │
  │ ・CheckCrit 暴击判定：                                 │
  │   a. critAtkFirst + 先手 → 必暴击                     │
  │   b. critAtkSecond + 后手 → 必暴击                    │
  │   c. critSelfHalfHp + 自身HP<50% → 必暴击            │
  │   d. critFoeHalfHp + 对方HP<50% → 必暴击             │
  │   e. 效果检查 (always_crit / no_crit)                 │
  │   f. random() × 16 <= (critRate + speedBonus)        │
  └─────────────────────┬───────────────────────────────┘
                        ▼
  ┌─────────────────────────────────────────────────────┐
  │ 阶段5: 造成伤害前                                     │
  │                                                      │
  │ ① OnBeforeDamageCalc — 伤害计算前效果                 │
  │    ・秒杀效果 (instant_kill) → damage=对方当前HP       │
  │      跳过后续所有伤害修正，直接到阶段6                   │
  │    ・固定伤害 (fixed_damage) → 使用固定值              │
  │      跳过公式计算                                      │
  │                                                      │
  │ ② CalculateDamage 伤害公式（详见第六节）               │
  │                                                      │
  │ ③ OnAfterDamageCalc — 伤害计算后（上限/下限修正）      │
  │                                                      │
  │ ④ OnBeforeDamageApply — 伤害应用前（伤害减免）         │
  └─────────────────────┬───────────────────────────────┘
                        ▼
  ┌─────────────────────────────────────────────────────┐
  │ 阶段6: 伤害结算                                       │
  │                                                      │
  │ ・defender.hp = max(0, hp - damage)                  │
  │ ・OnHPChange — HP变化效果（阈值触发等）                │
  └─────────────────────┬───────────────────────────────┘
                        ▼
  ┌─────────────────────────────────────────────────────┐
  │ 阶段7: 造成伤害后                                     │
  │                                                      │
  │ ・OnAfterDamageApply — 伤害应用后（吸血、反伤）        │
  │ ・OnReceiveDamage — 受到伤害效果                      │
  │ ・OnAfterSkill — 技能使用后（能力变化、状态施加）       │
  └─────────────────────┬───────────────────────────────┘
                        ▼
  ┌─────────────────────────────────────────────────────┐
  │ 阶段8: ATTACK_END — 出手流程结束                       │
  │                                                      │
  │ ・OnAttackEnd — 出手结束效果                          │
  │ ・防御方死亡?                                         │
  │   ├── OnKO — 击败效果                                │
  │   └── OnAfterKO — 击败后效果                          │
  └─────────────────────┬───────────────────────────────┘
                        ▼
                   返回攻击结果

  ═══════════════════════════════════════════════════════
  （回到 ExecuteTurn，双方攻击都完成后）

  ┌─────────────────────────────────────────────────────┐
  │ 阶段9: AFTER_ATTACK_END — 双方攻击完成后               │
  │                                                      │
  │ ・OnAfterAttackEnd — 双方完成后效果                   │
  │ ・死亡检查                                            │
  └─────────────────────────────────────────────────────┘
```

---

## 六、核心公式

### 6.1 属性计算

```
体力 HP:
  (种族值×2 + 个体值 + 学习力÷4) × 等级÷100 + 等级 + 10

非体力属性 (攻击/防御/特攻/特防/速度):
  [(种族值×2 + 个体值 + 学习力÷4) × 等级÷100 + 5] × 性格修正

简化版 (NPC/野怪，个体值=15，无学习力，平衡性格):
  HP: (种族值×2 + 15) × 等级÷100 + 等级 + 10
  其他: (种族值×2 + 15) × 等级÷100 + 5
```

### 6.2 伤害公式

```
基础伤害 = (等级 × 0.4 + 2) × 威力 × 攻击 ÷ 防御 ÷ 50 + 2

物理技能: 攻击 = attacker.attack,  防御 = defender.defence
特殊技能: 攻击 = attacker.spAtk,   防御 = defender.spDef

最终伤害 = floor(基础伤害 × 属性克制 × 本系加成 × 暴击 × 随机波动
                         × 刻印加成 × 战队加成 × 其他加成)

其中:
  属性克制 = 2.0 (克制) / 1.0 (普通) / 0.5 (被克制)
  本系加成 = 1.5 (技能属性=精灵属性) / 1.0 (不同)
  暴击     = 1.5 (暴击) / 1.0 (不暴击)
  随机波动 = 0.85 ~ 1.00
  最小伤害 = 1 (属性无效时可以为0)
```

### 6.3 能力等级修正（攻击/防御/特攻/特防/速度）

使用 2/(2+n) 分数系统：

| 等级 | -6 | -5 | -4 | -3 | -2 | -1 | 0 | +1 | +2 | +3 | +4 | +5 | +6 |
|------|-----|-----|-----|-----|-----|-----|---|------|------|------|------|------|------|
| 倍率 | 2/8 | 2/7 | 2/6 | 2/5 | 2/4 | 2/3 | 1 | 3/2 | 4/2 | 5/2 | 6/2 | 7/2 | 8/2 |
| 小数 | 0.25 | 0.29 | 0.33 | 0.40 | 0.50 | 0.67 | 1.0 | 1.50 | 2.00 | 2.50 | 3.00 | 3.50 | 4.00 |

```
修正后属性 = floor(基础属性 × 倍率)
```

### 6.4 命中/闪避等级修正

使用 3/(3+n) 分数系统（参考宝可梦第三世代）：

| 等级 | -6 | -5 | -4 | -3 | -2 | -1 | 0 | +1 | +2 | +3 | +4 | +5 | +6 |
|------|-----|-----|-----|-----|-----|-----|---|------|------|------|------|------|------|
| 倍率 | 3/9 | 3/8 | 3/7 | 3/6 | 3/5 | 3/4 | 1 | 4/3 | 5/3 | 6/3 | 7/3 | 8/3 | 9/3 |
| 小数 | 0.33 | 0.38 | 0.43 | 0.50 | 0.60 | 0.75 | 1.0 | 1.33 | 1.67 | 2.00 | 2.33 | 2.67 | 3.00 |

```
最终命中率 = floor(技能命中率 × 命中倍率 ÷ 闪避倍率)

其中:
  命中倍率 = 攻击方 battleLv[5] 对应的倍率
  闪避倍率 = 防御方 battleLv[5] 对应的倍率

例: 技能命中80%, 攻击方命中+1, 防御方闪避+2
  = floor(80 × (4/3) / (5/3))
  = floor(80 × 4/5)
  = 64%
```

### 6.5 暴击判定

```
暴击率 = (critRate + speedBonus) / 16

其中:
  critRate   = 技能暴击率 (默认1)
  speedBonus = max(0, 攻击方速度等级) — 速度正等级增加暴击

判定: random() × 16 <= (critRate + speedBonus)

特殊暴击条件（优先于公式）:
  ・critAtkFirst  + 先出手 → 必暴击
  ・critAtkSecond + 后出手 → 必暴击
  ・critSelfHalfHp + 自身HP < 50% → 必暴击
  ・critFoeHalfHp  + 对方HP < 50% → 必暴击
  ・效果 always_crit → 必暴击
  ・效果 no_crit → 不暴击
```

### 6.6 属性克制表

```
草(1)   克 水、地面
水(2)   克 火、地面
火(3)   克 草、机械、冰
飞行(4) 克 草、战斗
电(5)   克 水、飞行
机械(6) 克 冰
地面(7) 克 火、电、机械
普通(8) 无克制
冰(9)   克 草、飞行、地面、龙
超能(10) 克 战斗
战斗(11) 克 普通、冰
光(12)  克 暗影
暗影(13) 克 超能、光
神秘(14) 无克制
龙(15)  克 龙
圣灵(16) 克 暗影、龙
```

---

## 七、PvE 与 PvP 差异

| 差异点 | PvE | PvP |
|--------|-----|-----|
| 敌方技能选择 | AI选择 (`BattleAI.SelectSkill`) | 玩家提交 |
| `TurnService.ExecuteTurn` 调用 | `ExecuteTurn(battle, skillId)` — pet2SkillId=undefined | `ExecuteTurn(battle, p1Skill, p2Skill)` — 传入双方技能 |
| `ProcessTurnStartEffects` | 调用（克制回合递减等） | 不调用 |
| skillId=0 的含义 | 不存在此情况 | 换精灵，使用 `GetNoActionSkill()`，该回合不攻击 |
| 敌方 userId | 硬编码 `0` | `battle.player2Id` |
| 回合提交 | 立即执行 | 双方都提交后才执行 |
| 换精灵 | 立即换 + 敌方反击（`ExecuteEnemyTurn`） | 作为回合动作提交，在回合开始前执行 |
| 捕捉/逃跑/道具 | 支持 | 不支持 |
| 战斗结束判定 | 当前精灵HP<=0 且无后备精灵 | 一方所有精灵HP<=0 |
| 胜利奖励 | 经验/金币/掉落 | 无 |

---

## 八、特殊操作流程

### 8.1 换精灵 (PvE)

```
客户端 CHANGE_PET (2407)
  │
  ▼
ValidateChangePet — 验证目标精灵存在且HP>0
  │
  ▼
UpdateBattlePet — 替换战斗精灵数据，重置能力等级和状态
  │
  ▼
发送 PacketChangePet — 通知客户端
  │
  ▼
ExecuteEnemyCounterAndSend — 敌方反击（简化版，只有敌方攻击一次）
  │   使用 TurnService.ExecuteEnemyTurn()
  │   不走完整回合流程，直接：AI选技能 → CanAct → 命中 → 暴击 → 伤害 → 扣血
  │
  ▼
CheckPlayerPetDeath — 检查玩家精灵是否阵亡
  ├── 有后备精灵 → 发送阵亡通知，等待客户端换精灵
  └── 无后备精灵 → 战斗结束，敌方胜利
```

### 8.2 换精灵 (PvP)

```
客户端 CHANGE_PET (2407)
  │
  ▼
action = { type: 'changePet', catchTime }
PvpBattleManager.SetPlayerAction(userId, action)
  │
  ├── 对手未提交 → 等待
  └── 对手已提交 → ResolvePvpTurn()
        │
        ├── ExecutePvpChangePet — 先执行换精灵（回合结算前）
        │   发送 PacketChangePet 给双方
        │
        └── TurnService.ExecuteTurn(battle, p1Skill, p2Skill)
            p1Skill 或 p2Skill = 0 → GetNoActionSkill() → CanAct=false → 不攻击
```

### 8.3 捕捉精灵

```
客户端 CATCH_MONSTER (2409)
  │
  ▼
TurnService.Catch(battle)
  │
  ├── 成功:
  │   ├── RewardService.ProcessCatch — 将精灵加入玩家背包
  │   ├── 发送 PacketCatchMonster
  │   ├── 发送 NOTE_FIGHT_OVER (reason=6 捕捉成功)
  │   └── 清理战斗
  │
  └── 失败:
      ├── 发送 PacketCatchMonster (catchTime=0)
      ├── ExecuteEnemyCounterAndSend — 敌方反击
      └── 玩家精灵阵亡? → 战斗结束
```

### 8.4 逃跑

```
客户端 ESCAPE_FIGHT (2410)
  │
  ▼
SyncBattlePetHP — 同步HP到数据库
发送 PacketEscapeFight
发送 NOTE_FIGHT_OVER (reason=1 逃跑)
清理战斗
```

### 8.5 使用道具

```
客户端 USE_PET_ITEM (2406)
  │
  ▼
恢复HP (当前固定恢复50HP)
发送 PacketUsePetItem
（注意：使用道具后不触发敌方反击，这与换精灵/捕捉失败不同）
```

---

## 九、效果钩子一览

`BattleEffectIntegration` 提供 26 个钩子，在战斗各阶段触发被动特性和技能效果。

### 战斗级钩子

| 钩子 | 触发时机 | 用途 |
|------|---------|------|
| `OnBattleStart` | 战斗开始 | 被动特性初始化、开场效果 |
| `OnBattleEnd` | 战斗结束 | 清理效果、重置状态 |

### 回合级钩子

| 钩子 | 触发时机 | 用途 |
|------|---------|------|
| `OnTurnStart` | 回合开始 | 状态时间递减、被动回合效果 |
| `OnTurnEnd` | 回合结束 | 持续伤害、回合结束效果 |
| `OnBeforeSpeedCheck` | 速度判定前 | 返回先制修正（alwaysFirst、priorityMod） |
| `OnAfterAttackEnd` | 双方攻击完成后 | 阶段9效果 |

### 攻击流程钩子（按执行顺序）

| 阶段 | 钩子 | 触发时机 | 用途 |
|------|------|---------|------|
| 1 | `OnAttackStart` | 出手开始 | 异常状态扣血 |
| 2 | `OnAttack` | 攻击时 | 攻击时触发效果 |
| 2 | `OnBeforeSkill` | 技能使用前 | 命中前的"使用技能时"效果 |
| 2 | `OnBeforeHitCheck` | 命中判定前 | 修改命中条件 |
| 2 | `OnHitCheck` | 命中判定中 | 必中(never_miss)等效果 |
| 2 | `OnAfterHitCheck` | 命中判定后 | 命中/未命中后处理 |
| 2 | `OnEvade` | 闪避时 | 闪避触发效果 |
| 3 | `OnHit` | 命中时 | 命中后立即触发 |
| 3 | `OnAttacked` | 受到攻击时 | 防御方被命中后触发 |
| 4 | `OnSkillEffect` | 即时效果结算 | 能力变化、状态施加 |
| 4 | `OnBeforeCritCheck` | 暴击判定前 | 修改暴击条件 |
| 4 | `OnCritCheck` | 暴击判定中 | 必暴击/暴击无效等 |
| 5 | `OnBeforeDamageCalc` | 伤害计算前 | 秒杀、固定伤害、伤害增幅 |
| 5 | `OnAfterDamageCalc` | 伤害计算后 | 伤害上限/下限修正 |
| 5 | `OnBeforeDamageApply` | 伤害应用前 | 伤害减免 |
| 6 | `OnHPChange` | HP变化时 | HP阈值触发效果 |
| 7 | `OnAfterDamageApply` | 伤害应用后 | 吸血、反伤 |
| 7 | `OnReceiveDamage` | 受到伤害时 | 受伤后反应 |
| 7 | `OnAfterSkill` | 技能使用后 | 附加能力变化、状态施加 |
| 8 | `OnAttackEnd` | 出手结束 | 出手结束时效果 |
| 8 | `OnKO` | 击败时 | 击败对方触发 |
| 8 | `OnAfterKO` | 击败后 | 击败对方后触发 |

### battleLv 能力数组说明

```
索引:  [0]    [1]    [2]     [3]     [4]    [5]
含义:  攻击   防御   特攻    特防    速度   命中/闪避

・攻击方 battleLv[5] → 作为命中等级
・防御方 battleLv[5] → 作为闪避等级
・数组固定6位，与客户端协议一致
```

### 异常状态枚举

```
索引  名称           效果
 0    麻痹 PARALYSIS  25%无法行动，速度减半
 1    中毒 POISON     每回合损失 1/8 maxHP
 2    烧伤 BURN       每回合损失 1/16 maxHP
 3    吸取 DRAIN      吸取对方体力
 4    被吸取 DRAINED  被对方吸取体力
 5    冻伤 FREEZE     每回合损失 1/16 maxHP
 6    害怕 FEAR       50%无法行动
 7    疲惫 FATIGUE    无法行动
 8    睡眠 SLEEP      无法行动
 9    石化 PETRIFY    无法行动
10    混乱 CONFUSION  33%无法行动
11    衰弱 WEAKNESS   —
12    山神守护        —
13    易燃 FLAMMABLE  —
14    狂暴 RAGE       —
15    冰封 ICE_SEAL   无法行动
16    流血 BLEED      每回合损失 1/8 maxHP
17    免疫下降        —
18    免疫异常状态     —
```
