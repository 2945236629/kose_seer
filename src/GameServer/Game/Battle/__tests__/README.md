# 战斗系统测试

这个目录包含战斗系统的完整测试套件，覆盖核心战斗逻辑、伤害计算、属性克制和技能效果。

## 📁 测试文件

### BattleAlgorithm.test.ts
测试战斗算法的核心功能：

- ✅ **属性计算**
  - 100级精灵属性计算
  - 性格修正应用
  - 学习力（努力值）影响
  - 简化计算（用于NPC/野怪）

- ✅ **伤害计算**
  - 物理伤害计算
  - 特殊伤害计算
  - 变化技能（无伤害）
  - 暴击系统
  - 属性克制影响
  - 能力等级修正

- ✅ **速度判定**
  - 速度高低判断
  - 优先度系统
  - 同速随机

- ✅ **能力等级系统**
  - 能力等级修正（-6到+6）
  - 命中/闪避等级
  - 最终命中率计算

- ✅ **属性克制系统**
  - 克制关系（2.0x）
  - 被克制关系（0.5x）
  - 普通效果（1.0x）

- ✅ **暴击系统**
  - 基础暴击率（6.25%）
  - 暴击等级提升
  - 暴击率上限

- ✅ **边界情况**
  - 等级限制（1-100）
  - 防御为0处理
  - 威力为0处理

### ElementSystem.test.ts
测试26种属性的克制系统：

- ✅ **基础属性查询**
  - 属性名称获取
  - 属性英文名获取
  - 属性ID验证

- ✅ **单属性克制**
  - 克制关系（2.0x）
  - 被克制关系（0.5x）
  - 普通效果（1.0x）
  - 无效属性处理

- ✅ **单属性攻击双属性**
  - 双克制（4.0x）
  - 一克一普通（1.5x）
  - 一克一无效（0.5x）

- ✅ **双属性攻击单属性**
  - 双克制（4.0x）
  - 一克一被克（1.25x）

- ✅ **双属性攻击双属性**
  - 复杂克制关系计算
  - 自动降级处理

- ✅ **本系加成 (STAB)**
  - 单属性本系加成（1.5x）
  - 双属性本系加成
  - 非本系无加成

- ✅ **完整伤害倍率**
  - 属性克制 + 本系加成
  - 各种组合情况

- ✅ **辅助方法**
  - 根据名称查询属性
  - 效果描述文本
  - 获取所有属性

- ✅ **边界情况**
  - 配置未加载处理
  - 无效配置数据处理

### SkillEffects.test.ts
测试各种技能效果：

- ✅ **伤害修正效果**
  - 伤害加成（multiply）
  - 伤害减少
  - 固定伤害（set）

- ✅ **能力等级变化**
  - 提升攻击等级
  - 降低防御等级
  - 等级上限（+6）
  - 等级下限（-6）

- ✅ **状态异常效果**
  - 施加麻痹/中毒等状态
  - 已有状态不覆盖
  - 概率触发

- ✅ **回复效果**
  - 百分比回复
  - 固定值回复
  - 回复上限（不超过最大HP）
  - 满血不回复

- ✅ **条件效果**
  - HP阈值判断
  - 先手/后手判断
  - 条件分支执行

- ✅ **特殊效果**
  - 反伤（recoil）
  - 吸收（absorb）

- ✅ **效果触发时机**
  - 正确时机触发
  - 错误时机不触发

- ✅ **效果验证**
  - 有效参数验证
  - 无效参数拒绝

- ✅ **边界情况**
  - 伤害为0处理
  - HP为0处理
  - 无效效果类型

## 🚀 运行测试

### 运行所有战斗测试
```bash
npm test Battle
```

### 运行特定测试文件
```bash
npm test BattleAlgorithm
npm test ElementSystem
npm test SkillEffects
```

### 监听模式（开发时使用）
```bash
npm run test:watch -- Battle
```

### 生成覆盖率报告
```bash
npm run test:coverage -- Battle
```

## 📊 测试覆盖目标

- **BattleAlgorithm**: 目标 >90% 覆盖率
- **ElementSystem**: 目标 >85% 覆盖率
- **SkillEffects**: 目标 >80% 覆盖率

## 🎯 测试价值

这些测试特别有价值，因为：

1. **复杂逻辑** - 战斗系统有大量边界情况和组合
2. **防止回归** - 修改一个地方容易影响其他功能
3. **文档作用** - 测试展示了系统的正确用法
4. **重构信心** - 可以放心优化代码，测试会保护你

## 🔧 添加新测试

当添加新的战斗功能时：

1. 在对应的测试文件中添加新的 `describe` 块
2. 测试正常情况、边界情况和错误情况
3. 确保测试名称清晰描述预期行为
4. 使用 AAA 模式（Arrange-Act-Assert）

### 示例

```typescript
describe('新功能', () => {
  test('应该正确处理正常情况', () => {
    // Arrange - 准备数据
    const input = createTestData();
    
    // Act - 执行操作
    const result = newFeature(input);
    
    // Assert - 验证结果
    expect(result).toBe(expected);
  });
  
  test('应该正确处理边界情况', () => {
    // ...
  });
});
```

## 📝 注意事项

1. **Mock 外部依赖** - 使用 `jest.mock()` 隔离测试
2. **独立测试** - 每个测试应该独立运行，不依赖其他测试
3. **清理状态** - 使用 `beforeEach` 和 `afterEach` 清理
4. **有意义的断言** - 不要只测试 `toBeDefined()`，要测试实际值

## 🐛 调试测试

如果测试失败：

1. 查看错误信息，了解哪个断言失败
2. 使用 `console.log()` 输出中间值
3. 运行单个测试：`npm test -- -t "测试名称"`
4. 使用 `--verbose` 查看详细输出

## 📚 参考资料

- [Jest 文档](https://jestjs.io/)
- [测试最佳实践](https://github.com/goldbergyoni/javascript-testing-best-practices)
- 战斗系统文档：`seer_server/docs/战斗流程.md`
