# å¿«é€Ÿå¼€å§‹æŒ‡å—

## 5åˆ†é’Ÿäº†è§£æŠ€èƒ½æ•ˆæœç³»ç»Ÿ

### 1. æ ¸å¿ƒæ¦‚å¿µ

**åŸå­æ•ˆæœ** = æœ€å°çš„æ•ˆæœå•å…ƒï¼ˆå¦‚ä¼¤å®³ä¿®æ­£ã€æ¡ä»¶åˆ¤æ–­ï¼‰  
**ç»„åˆæ•ˆæœ** = å¤šä¸ªåŸå­æ•ˆæœçš„ç»„åˆï¼ˆå¦‚å…ˆæ‰‹å¨åŠ›æå‡ = æ¡ä»¶åˆ¤æ–­ + å¨åŠ›ä¿®æ­£ï¼‰  
**æ•ˆæœé…ç½®** = JSONä¸­å®šä¹‰æ•ˆæœå¦‚ä½•ç»„åˆ

### 2. ç›®å½•ç»“æ„

```
effects/
â”œâ”€â”€ core/           # åŸºç¡€ç±»ï¼ˆBaseEffect, EffectContextï¼‰
â”œâ”€â”€ atomic/         # åŸå­æ•ˆæœï¼ˆConditionalCheck, DamageModifierç­‰ï¼‰
â”œâ”€â”€ composite/      # ç»„åˆæ•ˆæœï¼ˆCompositeEffectï¼‰
â””â”€â”€ EffectFactory   # ä»JSONåˆ›å»ºæ•ˆæœ
```

### 3. ä½¿ç”¨ç¤ºä¾‹

#### æ­¥éª¤1: åœ¨JSONä¸­é…ç½®æ•ˆæœ

```json
{
  "effectId": 46,
  "name": "å…ˆæ‰‹å¨åŠ›æå‡",
  "timing": ["BEFORE_DAMAGE_CALC"],
  "atomicComposition": {
    "type": "composite",
    "atoms": [
      {
        "type": "conditional",
        "condition": "first_strike",
        "then": [
          {
            "type": "power_modifier",
            "mode": "multiply",
            "value": 50
          }
        ]
      }
    ]
  }
}
```

#### æ­¥éª¤2: åˆ›å»ºæ•ˆæœå®ä¾‹

```typescript
import { effectFactory } from './effects';

const effect = effectFactory.createEffect(46);
```

#### æ­¥éª¤3: æ‰§è¡Œæ•ˆæœ

```typescript
import { createEffectContext, EffectTiming } from './effects';

const context = createEffectContext(
  attacker,
  defender,
  skillId,
  damage,
  EffectTiming.BEFORE_DAMAGE_CALC
);

const results = effect.execute(context);
```

### 4. å·²å®ç°çš„åŸå­æ•ˆæœ

- âœ… **ConditionalCheck** - æ¡ä»¶åˆ¤æ–­ï¼ˆå…ˆæ‰‹/åæ‰‹/HP/çŠ¶æ€ç­‰ï¼‰
- âœ… **DamageModifier** - ä¼¤å®³ä¿®æ­£ï¼ˆä¹˜æ³•/åŠ æ³•/è®¾ç½®ï¼‰
- âœ… **PowerModifier** - å¨åŠ›ä¿®æ­£ï¼ˆä¹˜æ³•/åŠ æ³•/è®¾ç½®ï¼‰

### 5. å¸¸ç”¨æ¡ä»¶ç±»å‹

```typescript
// é€Ÿåº¦
first_strike      // å…ˆæ‰‹
second_strike     // åæ‰‹

// HP
hp_percent_below  // HPç™¾åˆ†æ¯”ä½äº
hp_percent_above  // HPç™¾åˆ†æ¯”é«˜äº

// çŠ¶æ€
self_has_status   // è‡ªèº«æœ‰å¼‚å¸¸çŠ¶æ€
target_has_status // å¯¹æ–¹æœ‰å¼‚å¸¸çŠ¶æ€

// èƒ½åŠ›
self_stat_boosted   // è‡ªèº«èƒ½åŠ›æå‡
target_stat_lowered // å¯¹æ–¹èƒ½åŠ›ä¸‹é™

// ä¼¤å®³
damage_even       // å¶æ•°ä¼¤å®³
damage_odd        // å¥‡æ•°ä¼¤å®³

// å…¶ä»–
always            // æ€»æ˜¯
probability       // æ¦‚ç‡è§¦å‘
```

### 6. æ•ˆæœæ—¶æœº

```typescript
BEFORE_SKILL        // æŠ€èƒ½ä½¿ç”¨å‰
BEFORE_SPEED_CHECK  // é€Ÿåº¦åˆ¤å®šå‰
BEFORE_HIT_CHECK    // å‘½ä¸­åˆ¤å®šå‰
BEFORE_CRIT_CHECK   // æš´å‡»åˆ¤å®šå‰
BEFORE_DAMAGE_CALC  // ä¼¤å®³è®¡ç®—å‰
AFTER_DAMAGE_CALC   // ä¼¤å®³è®¡ç®—å
AFTER_DAMAGE_APPLY  // ä¼¤å®³åº”ç”¨å
AFTER_SKILL         // æŠ€èƒ½ä½¿ç”¨å
```

### 7. é…ç½®æ¨¡æ¿

#### ç®€å•æ•ˆæœï¼ˆæ— æ¡ä»¶ï¼‰

```json
{
  "atomicComposition": {
    "type": "composite",
    "atoms": [
      {
        "type": "damage_modifier",
        "mode": "multiply",
        "value": 50
      }
    ]
  }
}
```

#### æ¡ä»¶æ•ˆæœ

```json
{
  "atomicComposition": {
    "type": "composite",
    "atoms": [
      {
        "type": "conditional",
        "condition": "first_strike",
        "then": [
          {
            "type": "power_modifier",
            "mode": "multiply",
            "value": 50
          }
        ]
      }
    ]
  }
}
```

#### å¤šæ¡ä»¶æ•ˆæœ

```json
{
  "atomicComposition": {
    "type": "composite",
    "atoms": [
      {
        "type": "conditional",
        "condition": "first_strike",
        "then": [
          {
            "type": "conditional",
            "condition": "hp_percent_below",
            "value": 50,
            "then": [
              {
                "type": "power_modifier",
                "mode": "multiply",
                "value": 100
              }
            ]
          }
        ]
      }
    ]
  }
}
```

### 8. ä¸‹ä¸€æ­¥

- æŸ¥çœ‹ [ä½¿ç”¨è¯´æ˜.md](./ä½¿ç”¨è¯´æ˜.md) äº†è§£è¯¦ç»†ä½¿ç”¨æ–¹æ³•
- æŸ¥çœ‹ [é…ç½®ç¤ºä¾‹.md](./é…ç½®ç¤ºä¾‹.md) æŸ¥çœ‹æ›´å¤šé…ç½®ç¤ºä¾‹
- æŸ¥çœ‹ [è®¾è®¡æ–‡æ¡£.md](./è®¾è®¡æ–‡æ¡£.md) äº†è§£è®¾è®¡ç†å¿µ
- æŸ¥çœ‹ [å®ç°çŠ¶æ€.md](./å®ç°çŠ¶æ€.md) äº†è§£å®ç°è¿›åº¦

### 9. å¸¸è§é—®é¢˜

**Q: å¦‚ä½•æ·»åŠ æ–°çš„åŸå­æ•ˆæœï¼Ÿ**  
A: ç»§æ‰¿ BaseAtomicEffectï¼Œå®ç° execute() å’Œ validate() æ–¹æ³•ï¼Œç„¶ååœ¨ AtomicEffectFactory ä¸­æ³¨å†Œã€‚

**Q: å¦‚ä½•æµ‹è¯•æ•ˆæœï¼Ÿ**  
A: åˆ›å»ºæµ‹è¯•ä¸Šä¸‹æ–‡ï¼Œè°ƒç”¨ effect.execute(context)ï¼Œæ£€æŸ¥ context ä¸­çš„å€¼æ˜¯å¦æ­£ç¡®ä¿®æ”¹ã€‚

**Q: æ•ˆæœä¼šè¢«ç¼“å­˜å—ï¼Ÿ**  
A: æ˜¯çš„ï¼ŒEffectFactory ä¼šç¼“å­˜å·²åˆ›å»ºçš„æ•ˆæœå®ä¾‹ï¼Œé¿å…é‡å¤åˆ›å»ºã€‚

**Q: å¦‚ä½•è°ƒè¯•æ•ˆæœï¼Ÿ**  
A: æŸ¥çœ‹æ—¥å¿—è¾“å‡ºï¼Œæ¯ä¸ªåŸå­æ•ˆæœéƒ½ä¼šè®°å½•æ‰§è¡Œä¿¡æ¯ã€‚

### 10. å¿«é€Ÿå‚è€ƒ

```typescript
// åˆ›å»ºæ•ˆæœ
const effect = effectFactory.createEffect(effectId);

// åˆ›å»ºä¸Šä¸‹æ–‡
const context = createEffectContext(attacker, defender, skillId, damage, timing);

// æ‰§è¡Œæ•ˆæœ
const results = effect.execute(context);

// æ£€æŸ¥ç»“æœ
console.log('ä¿®æ”¹åçš„ä¼¤å®³:', context.damage);
console.log('ä¿®æ”¹åçš„å¨åŠ›:', context.skillPower);
console.log('æ•ˆæœç»“æœ:', results);
```

## å¼€å§‹ä½¿ç”¨

ç°åœ¨ä½ å·²ç»äº†è§£äº†åŸºç¡€çŸ¥è¯†ï¼Œå¯ä»¥å¼€å§‹ï¼š

1. ä¸ºä½ çš„æ•ˆæœæ·»åŠ  `atomicComposition` é…ç½®
2. ä½¿ç”¨ EffectFactory åˆ›å»ºæ•ˆæœå®ä¾‹
3. åœ¨æˆ˜æ–—æµç¨‹ä¸­æ‰§è¡Œæ•ˆæœ
4. æŸ¥çœ‹æ•ˆæœç»“æœå¹¶åº”ç”¨åˆ°æˆ˜æ–—çŠ¶æ€

ç¥ä½ ä½¿ç”¨æ„‰å¿«ï¼ğŸš€
